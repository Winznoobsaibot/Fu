<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebSocket Tester</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5" />
    <meta name="msapplication-TileColor" content="#2d89ef" />
    <meta name="theme-color" content="#ffffff" />
    <style>
      body {
        font-family: Helvetica, Arial, sans-serif;
      }
    </style>
  </head>
  <body>
    <div
      class="d-flex align-items-center justify-content-center"
      style="padding: 5% 25%; flex-direction: column"
    >
      <h4>WebSocket Tester</h4>
      <br />
      <div
        id="join"
        class="d-flex align-items-center justify-content-center w-100"
        style="flex-direction: column"
      >
        <div style="width: 100%">
          <label for="room">Room</label>
          <input
            type="text"
            class="form-control"
            id="room"
            style="width: 100%"
            required
          />
        </div>
        <br />
        <div style="width: 100%">
          <label for="key">Key</label>
          <input
            type="text"
            class="form-control"
            id="key"
            style="width: 100%"
            required
          />
        </div>
        <br />
        <button
          type="button"
          class="btn btn-primary"
          id="joinBtn"
          onclick="joinRoom()"
        >
          Join
        </button>
      </div>
      <div id="info" style="display: none; width: 70%; align-items: center">
        <h5>Room: <span id="roomName"></span></h5>
        <h5>Key: <span id="keyName"></span></h5>
        <br />
        <button type="button" class="btn btn-primary" onclick="refresh()">
          Refresh
        </button>
      </div>
      <div id="chat" style="display: none; width: 70%; text-align: center">
        <br />
        <textarea
          id="chat-log"
          class="form-control"
          style="resize: none; overflow-y: scroll; height: 250px; width: 100%"
          readonly
        ></textarea>
        <br />
        <input
          id="chat-message-input"
          style="width: 100%"
          class="form-control"
          type="text"
          placeholder="Message"
        />
        <br />
        <br />
        <input
          id="chat-message-submit"
          type="button"
          class="btn btn-primary"
          value="Send"
        />
      </div>
    </div>
    <div class="position-absolute bottom-0 left-0 w-100">
      <div class="text-center w-100">
        <small>
          <small>
            Made by
            <a
              href="https://satshree.com.np/"
              style="text-decoration: none"
              target="_blank"
              >Satshree Shrestha</a
            >
            |
            <a
              href="https://github.com/satshree/websocket-tester"
              style="text-decoration: none"
              target="_blank"
              >GitHub</a
            >
          </small>
        </small>
      </div>
    </div>
    <script>
      let key;

      function loading() {
        document.querySelector("#joinBtn").innerText = "Joining...";
        document.querySelector("#joinBtn").setAttribute("disabled", "disabled");
      }

      function loadingDone() {
        document.querySelector("#joinBtn").innerText = "Join";
        document.querySelector("#joinBtn").removeAttribute("disabled");
      }

      function refresh() {
        window.location.href = "";
      }

      function joinRoom() {
        loading();

        let room = document.querySelector("#room").value.trim();
        key = document.querySelector("#key").value.trim();

        if (room && key) {
          startWebsocket(room);
          document.cookie = "auth=" + key + "; max-age=30";
        } else {
          alert("Enter proper room and key.");
          loadingDone();
        }
      }

      function startWebsocket(room) {
        let wsStart = "ws://";
        if (window.location.protocol == "https:") {
          wsStart = "wss://";
        }

        const chatSocket = new WebSocket(wsStart + room);

        chatSocket.onopen = function (e) {
          loadingDone();
          document.querySelector("#roomName").innerText = room;
          document.querySelector("#keyName").innerText = key;
          document.querySelector("#join").style.display = "none";
          document.querySelector("#info").style.display = "block";
          document.querySelector("#chat").style.display = "block";
        };

        chatSocket.onmessage = function (e) {
          let data = JSON.parse(e.data);
          console.log("SOCKET MESSAGE", data);
          document.querySelector("#chat-log").value +=
            `${JSON.stringify(data.message)}` + "\n";
        };

        chatSocket.onclose = function (e) {
          loadingDone();
          console.log("SOCKET CLOSED.", e);
          alert("Socket closed. (Check console.)");
          document.querySelector("#info").style.display = "none";
          document.querySelector("#chat").style.display = "none";
          document.querySelector("#join").style.display = "flex";
        };

        chatSocket.onerror = function (e) {
          loadingDone();
          console.log("ERROR", e);
          alert("Socket error. (Check console.)");
        };

        document.querySelector("#chat-message-input").focus();
        document.querySelector("#chat-message-input").onkeyup = function (e) {
          if (e.keyCode === 13) {
            // enter, return
            document.querySelector("#chat-message-submit").click();
          }
        };

        document.querySelector("#chat-message-submit").onclick = function (e) {
          const messageInputDom = document.querySelector("#chat-message-input");
          let message = messageInputDom.value;

          chatSocket.send(
            JSON.stringify({
              sender: "WEB_CLIENT",
              message: message,
            })
          );
          messageInputDom.value = "";
        };
      }
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
